name: Windows

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    # We only need one runner (Ubuntu) because Nix will handle the cross-compilation.
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 1. Setup MSYS2 environment.
    - name: Setup MSYS2 Environment
      uses: msys2/setup-msys2@v2
      with:
        # Use the MinGW 64-bit subsystem
        msystem: MINGW64 
        # This ensures the MSYS2 environment is fully initialized.
        update: true 

    # 2. Install Dependencies (Added retry logic for network stability)
    - name: Install GTK4 and Rust Dependencies
      id: install_deps
      run: |
        # Define the list of packages to install
        PACKAGES="mingw-w64-x86_64-toolchain \
          mingw-w64-x86_64-pkg-config \
          mingw-w64-x86_64-gtk4 \
          mingw-w64-x86_64-libadwaita \
          mingw-w64-x86_64-glib2 \
          mingw-w64-x86_64-gobject-introspection \
          mingw-w64-x86_64-rust \
          zip \
          git \
          make"

        # Use a loop to retry installation up to 3 times in case of transient network errors
        RETRY_COUNT=0
        MAX_RETRIES=3
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          # Upgrade and then install packages
          pacman -Syu --noconfirm && pacman -S --noconfirm $PACKAGES
          
          # Check the exit code of the last command
          if [ $? -eq 0 ]; then
            echo "Installation successful on attempt $((RETRY_COUNT + 1))."
            exit 0 # Exit the loop successfully
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Installation failed on attempt $RETRY_COUNT. Retrying in 5 seconds..."
            sleep 5 # Wait before retrying
          fi
        done
        
        # If the loop finishes without success
        echo "Installation failed after $MAX_RETRIES attempts."
        exit 1
      
      # Ensure this command runs inside the MINGW64 shell context.
      shell: msys2 {0}

    # 3. Build the application
    - name: Build GTK-RS Application
      # We set CARGO_TARGET_DIR for a simpler path, and the build runs from the project root.
      run: CARGO_TARGET_DIR=build_output cargo build --release
      # Ensure this command runs inside the MINGW64 shell context.
      shell: msys2 {0}

    # 4. Packaging Step: Copy DLLs and ZIP the application for distribution
    - name: Package Windows Executable with DLLs
      id: package
      run: |
        # Define the target executable path and the packaging folder
        # CORRECTED PATH: Now includes the nested 'Mass-Combat-Decider' directory
        EXE_PATH="./Mass-Combat-Decider/build_output/x86_64-pc-windows-gnu/release/MassCombatDecider.exe"
        PACKAGE_DIR="MassCombatDecider-Windows-Portable"
        ZIP_NAME="${PACKAGE_DIR}.zip"
        
        # Create the final package directory
        mkdir -p ${PACKAGE_DIR}/bin
        
        # Copy the built executable into the package directory
        cp ${EXE_PATH} ${PACKAGE_DIR}/bin/
        
        # Get the MinGW installation path (needed for DLL copying)
        MINGW_ROOT=$(dirname $(which pacman))
        
        echo "Copying runtime DLLs..."
        
        # We manually list the most critical DLLs/folders for GTK/Adwaita to ensure portability.
        
        # Copy core GTK/Glib/Adwaita DLLs (essential)
        for DLL in gtk-4-1.dll libadwaita-1.dll libgdk_pixbuf-2.0-0.dll; do
            cp ${MINGW_ROOT}/bin/${DLL} ${PACKAGE_DIR}/bin/ || true
        done
        
        # Copy other essential dependencies like Glib, Pango, Cairo, etc. (using find for robustness)
        find ${MINGW_ROOT}/bin -maxdepth 1 -type f \( -name "libg*.dll" -o -name "libcairo*.dll" -o -name "libpango*.dll" -o -name "libgio*.dll" -o -name "libz*.dll" -o -name "libiconv*.dll" \) -exec cp {} ${PACKAGE_DIR}/bin/ \; || true
        
        # Copy required data directories (crucial for GTK themes/icons/schemas)
        cp -r ${MINGW_ROOT}/share/glib-2.0 ${PACKAGE_DIR}/share/
        cp -r ${MINGW_ROOT}/share/gtk-4.0 ${PACKAGE_DIR}/share/
        cp -r ${MINGW_ROOT}/share/libadwaita-1 ${PACKAGE_DIR}/share/
        cp -r ${MINGW_ROOT}/share/themes ${PACKAGE_DIR}/share/
        
        # Zip the final package
        zip -r ${ZIP_NAME} ${PACKAGE_DIR}
        
        # Output the path for the next step (upload)
        echo "ARTIFACT_PATH=${ZIP_NAME}" >> $GITHUB_OUTPUT
      
      shell: msys2 {0}

    - name: Upload Windows Portable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-app-portable-zip
        # Use the path output from the previous step
        path: ${{ steps.package.outputs.ARTIFACT_PATH }}
        retention-days: 7

