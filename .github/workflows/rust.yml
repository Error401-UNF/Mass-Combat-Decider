name: Rust

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ------------------
      # 1. Setup Nix Environment
      # ------------------
      - name: Install Nix and Setup Flake Cache
        # This action automatically installs Nix and configures the environment for flakes.
        uses: DeterminateSystems/nix-installer-action@main

      - name: Enable Experimental Features for Cross-Compilation
        # Cross-compilation often requires the `flakes` and `nix-command` features.
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
          # Allow untrusted paths for the build process
          echo "build-users-group = nixbld" >> ~/.config/nix/nix.conf

      # ------------------
      # 2. Build for Linux (Native Target)
      # ------------------
      - name: Build Linux Binary (Native)
        # Uses 'nix build' to execute the build within the environment defined by your flake.
        # The `--file` flag points to your flake and the `devShells` environment.
        run: |
          echo "Building Linux executable..."
          nix develop --command cargo build --release --target x86_64-unknown-linux-gnu
        
      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux-x86_64-release
          # Assumes your crate name is 'minimal' based on Cargo.toml, adjust if necessary.
          path: target/x86_64-unknown-linux-gnu/release/*

      # ------------------
      # 3. Cross-Compile for Windows (MinGW Target)
      # ------------------
      - name: Cross-Compile Windows Binary (x86_64-pc-windows-gnu)
        # Uses 'nix build' targeting the explicit cross-compiled package definition in flake.nix
        run: |
          echo "Cross-compiling Windows executable..."
          nix build .#packages.x86_64-pc-windows-gnu.default --out-link result-windows
          
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-x86_64-release
          # The result is symlinked by the previous command
          path: result-windows/bin/*.exe
        with:
          name: Windows-x86_64-release
          path: target/x86_64-pc-windows-gnu/release/*.exe
