name: Linux

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    # We only need one runner (Ubuntu) because Nix will handle the cross-compilation.
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Setup Nix in the GitHub Actions runner
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org/
            
      # Install the required dependency for AppImage bundling
      - name: Install Bundler Dependencies
        run: |
          nix profile install github:ralismark/nix-appimage

      # Build the AppImage bundle
      - name: Build Linux App Bundle (AppImage)
        id: nix_build
        run: |
          # Use nix bundle with the external bundler to create the AppImage
          # The output will be a store path that links to the .AppImage file
          nix bundle . --bundler github:ralismark/nix-appimage
          
          # Find the resulting AppImage file in the current directory (linked by 'result-bundle')
          # The file name will be something like: mass-combat-decider-portable-0.1.0.AppImage
          APPIMAGE_NAME=$(ls *.AppImage)
          
          # Output the path for the next step (upload)
          echo "ARTIFACT_PATH=${APPIMAGE_NAME}" >> $GITHUB_OUTPUT


      - name: Upload Linux App Bundle Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-app-bundle
          path: ${{ steps.nix_build.outputs.ARTIFACT_PATH }}
          retention-days: 7